<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>harper js</title>

  <style>
    body { font-family: sans-serif; }
    mark.err { background: #ffcccc; border-bottom: 2px solid #c94a4a; padding: 0 2px; color: transparent; }
    .editor-wrapper { position: relative; width: 100%; min-height: 200px; margin-bottom: 2rem; }
    .highlight-layer {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      white-space: pre-wrap; pointer-events: none; padding: 8px;
      color: transparent; overflow-wrap: break-word; z-index: 1;
      line-height: 1.5;
      font-family: sans-serif;
      font-size: 16px;
    }
    #maininput {
      position: relative; z-index: 2; background: transparent; color: black;
      width: 100%; min-height: 200px; padding: 8px; resize: vertical;
      line-height: 1.5;
      font-family: sans-serif;
      font-size: 16px;
    }
    .error-text { color: #c94a4a; font-weight: bold; }
    .error-message { color: #555; }
    .error-suggestion { color: #4CAF50; font-style: italic; }
  </style>

  <script type="module">
    import { WorkerLinter } from "https://cdn.jsdelivr.net/npm/harper.js@0.14.0/dist/harper.js";

    const harperConfig = {
      linters: {
        SentenceCapitalization: true,
        Spaces: true,
        SpellCheck: true,
        RepeatedWords: true,
        AnA: true,
        Matcher: true
      }
    };

    let linter = new WorkerLinter(harperConfig);

    function applyHighlights(text, lints) {
      let html = "";
      let lastIndex = 0;

      for (let l of lints) {
        const sp = l.span();
        const start = sp.start;
        const end = sp.end;

        html += escapeHTML(text.slice(lastIndex, start));
        html += `<mark class="err">${escapeHTML(text.slice(start, end))}</mark>`;
        lastIndex = end;
      }

      html += escapeHTML(text.slice(lastIndex));
      return html;
    }

    function escapeHTML(str) {
      return str.replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");
    }

    async function onInput(e) {
      const textToLint = e.target.value.replace(/\u00A0/g, " ");
      let lints = await linter.lint(textToLint);

      document.getElementById("highlight").innerHTML = applyHighlights(textToLint, lints);

      let list = document.getElementById("errorlist");
      list.innerHTML = "";

      for (let lint of lints) {
        const sp = lint.span();
        const bad = textToLint.substring(sp.start, sp.end);

        let li = document.createElement("li");

        let badSpan = document.createElement("span");
        badSpan.className = "error-text";
        badSpan.textContent = `"${bad}"`;
        li.appendChild(badSpan);

        let msgSpan = document.createElement("span");
        msgSpan.className = "error-message";
        msgSpan.textContent = ` — ${lint.message()}`;
        li.appendChild(msgSpan);

        if (lint.suggestion_count() > 0) {
          const suggestions = [...lint.suggestions()]
            .map(s => `‘${s.get_replacement_text()}’`)
            .join(", ");

          let sugSpan = document.createElement("span");
          sugSpan.className = "error-suggestion";
          sugSpan.textContent = ` Suggestion(s): ${suggestions}`;
          li.appendChild(sugSpan);
        }

        list.appendChild(li);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const inputField = document.getElementById("maininput");
      const highlight = document.getElementById("highlight");

      function debounce(fn, delay) {
        let timer;
        return (...args) => {
          clearTimeout(timer);
          timer = setTimeout(() => fn(...args), delay);
        };
      }

      const debouncedInput = debounce(onInput, 120);

      inputField.addEventListener("input", debouncedInput);

      inputField.addEventListener("scroll", () => {
        highlight.scrollTop = inputField.scrollTop;
        highlight.scrollLeft = inputField.scrollLeft;
      });

      onInput({ target: inputField });
    });
  </script>
</head>
<body>

<h1>harper.js</h1>

<div class="editor-wrapper">
  <div id="highlight" class="highlight-layer"></div>
  <textarea id="maininput" rows="10">
There are some cases where the the standard grammar
checkers don't cut it. That s where Harper comes in handy.

Harper is an language checker for developers. it can detect
improper capitalization and misspellled words,
as well as a number of other issues.
Like if you break up words you shoul dn't.
Harper can be a lifesaver when writing technical documents, 
emails or other formal forms of communication.

Harper works everywhere, even offline. Since your data
never leaves your device, you don't need to worry aout us
selling it or using it to train large language models, 
despite of the consequences.

The best part: Harper can give you feedback instantly.
For most documents, Harper can serve up suggestions in
under 10 ms.</textarea>
</div>

<h2>Errors</h2>
<ul id="errorlist">
  <li>Loading...</li>
</ul>

</body>
</html>
