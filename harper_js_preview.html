<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>harper js</title>

  <style>
    body { font-family: sans-serif; }
    mark.err { background: #ffcccc; border-bottom: 2px solid #c94a4a; padding: 0 2px; color: black; display: inline; }
    .editor-wrapper { position: relative; width: 100%; min-height: 200px; margin-bottom: 2rem; }
    .highlight-layer {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      white-space: pre-wrap; pointer-events: none; padding: 8px;
      color: transparent; overflow-wrap: break-word; z-index: 1;
      line-height: 1.5;
      font-family: sans-serif;
      font-size: 16px;
    }
    #maininput {
      position: relative; z-index: 2; background: transparent; color: black;
      width: 100%; min-height: 200px; padding: 8px; resize: none; overflow: hidden;
      line-height: 1.5;
      font-family: sans-serif;
      font-size: 16px;
    }
    .error-text { color: #c94a4a; font-weight: bold; }
    .error-message { color: #555; }
    .error-suggestion { color: #4CAF50; font-style: italic; }
  </style>

  <script type="module">
    import { WorkerLinter } from "https://cdn.jsdelivr.net/npm/harper.js@0.14.0/dist/harper.js";

    const harperConfig = {
      linters: {
        SentenceCapitalization: true,
        Spaces: true,
        SpellCheck: true,
        RepeatedWords: true,
        AnA: true,
        Matcher: true
      }
    };

    let linter = new WorkerLinter(harperConfig);
    let currentLints = [];

    function applyHighlights(text, lints) {
      let html = "";
      let lastIndex = 0;

      for (let l of lints) {
        const sp = l.span();
        const start = sp.start;
        const end = sp.end;

        html += escapeHTML(text.slice(lastIndex, start));
        html += `<mark class="err" data-start="${start}" data-end="${end}">${escapeHTML(text.slice(start, end))}</mark>`;
        lastIndex = end;
      }

      html += escapeHTML(text.slice(lastIndex));
      return html;
    }

    function escapeHTML(str) {
      return str.replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");
    }

    async function onInput(e) {
      const textarea = document.getElementById('maininput');
      const textToLint = textarea.value.replace(/\u00A0/g, " ");
      let lints = await linter.lint(textToLint);
      currentLints = lints;

      document.getElementById("highlight").innerHTML = applyHighlights(textToLint, lints);

      let list = document.getElementById("problemsList");
      list.innerHTML = "";

      const colorMap = { SpellCheck:'#f4c542', RepeatedWords:'#4CAF50', SentenceCapitalization:'#42a5f5', Matcher:'#ef5350', Spaces:'#ab47bc', AnA:'#26a69a' };

      lints.forEach((lint, idx) => {
        const sp = lint.span();
        const bad = textToLint.substring(sp.start, sp.end);

        const card = document.createElement("div");
        card.className = "problem-card";
        card.style.border = "1px solid #e5e5e5";
        card.style.borderRadius = "12px";
        card.style.padding = "16px";
        card.style.background = "#fff";
        card.style.boxShadow = "0 1px 3px rgba(0,0,0,0.08)";
        const barColor = colorMap[lint.linter_name()] || '#f4c542';
        card.innerHTML = `
          <div style='display:flex; justify-content:space-between; align-items:center;'>
            <div style='font-weight:600; font-size:15px; display:flex; align-items:center; gap:8px;'>
              <div style="width:6px; height:16px; border-radius:4px; background:${barColor};"></div>
              ${lint.linter_name()}
            </div>
            <button class='apply-fix' data-idx='${idx}' style='background:#2DA44E; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer; font-size:12px;'>Apply fix</button>
          </div>
          <div style='margin-top:8px; font-size:14px; color:#444;'>${escapeHTML(lint.message())}</div>
          <div style='margin-top:10px; background:#f9f9f9; padding:10px; border-radius:8px; font-size:13px; word-break:break-word;'>${escapeHTML(bad)}</div>
        `;
        card.dataset.start = sp.start;
        card.dataset.end = sp.end;
        list.appendChild(card);

        // click card → select range in textarea and show tooltip
        card.addEventListener('click', (ev) => {
          ev.stopPropagation();
          const ta = document.getElementById('maininput');
          ta.focus();
          ta.selectionStart = sp.start;
          ta.selectionEnd = sp.end;

          // scroll to approx line
          const before = ta.value.slice(0, sp.start);
          const line = before.split('\n').length - 1;
          const lh = parseFloat(getComputedStyle(ta).lineHeight) || (parseFloat(getComputedStyle(ta).fontSize) * 1.6);
          ta.scrollTop = Math.max(0, (line * lh) - 40);

          showTooltipForLint(sp.start, sp.end, lint);
        });

        // apply-fix button
        const applyBtn = card.querySelector('.apply-fix');
        applyBtn.addEventListener('click', (ev) => {
          ev.stopPropagation();
          if (lint.suggestion_count() > 0) {
            const first = lint.suggestions().next().value;
            const replacement = first.get_replacement_text();
            applyReplacement(sp.start, sp.end, replacement);
          }
        });
      });
    }

    function applyReplacement(start, end, replacement) {
      const ta = document.getElementById('maininput');
      const v = ta.value;
      ta.value = v.slice(0, start) + replacement + v.slice(end);
      autoResize();
      // re-run lint
      onInput({ target: ta });
    }

    function showTooltipForLint(start, end, lint) {
      const tooltip = document.getElementById('lintTooltip');
      const editorRect = document.querySelector('.editor-wrapper').getBoundingClientRect();

      // find approximate position by measuring text before start in a mirror div
      const mirror = document.createElement('div');
      const ta = document.getElementById('maininput');
      const style = getComputedStyle(ta);
      mirror.style.position = 'absolute';
      mirror.style.visibility = 'hidden';
      mirror.style.whiteSpace = 'pre-wrap';
      mirror.style.font = style.font;
      mirror.style.lineHeight = style.lineHeight;
      mirror.style.width = ta.clientWidth + 'px';
      mirror.textContent = ta.value.slice(0, start);
      document.body.appendChild(mirror);
      const mirrorRect = mirror.getBoundingClientRect();
      document.body.removeChild(mirror);

      const top = editorRect.top + (mirrorRect.height);
      const left = editorRect.left + editorRect.width - 280; // position near right edge of editor

      tooltip.style.top = (top + window.scrollY) + 'px';
      tooltip.style.left = (left + window.scrollX) + 'px';
      tooltip.innerHTML = `
        <div style='font-weight:600; margin-bottom:6px;'>${lint.linter_name()}</div>
        <div style='font-size:13px; margin-bottom:8px;'>${escapeHTML(lint.message())}</div>
        ${lint.suggestion_count() > 0 ? `<div style='display:flex; gap:8px; justify-content:flex-end;'><button id='tooltipApply' style='background:#2DA44E;color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;'>Apply</button></div>` : ''}
      `;
      tooltip.style.display = 'block';

      const btn = document.getElementById('tooltipApply');
      if (btn) {
        btn.addEventListener('click', () => {
          const first = lint.suggestions().next().value;
          const replacement = first.get_replacement_text();
          applyReplacement(start, end, replacement);
          tooltip.style.display = 'none';
        });
      }

      // hide on outside click
      setTimeout(() => {
        document.addEventListener('click', hideTooltipOnce, { once: true });
      }, 0);

      function hideTooltipOnce() { document.getElementById('lintTooltip').style.display = 'none'; }
    }

    function autoResize() {
      const input = document.getElementById("maininput");
      const ghost = document.getElementById("highlight");
      if (!input) return;
      input.style.height = "auto";
      input.style.height = input.scrollHeight + "px";
      if (ghost) ghost.style.height = input.scrollHeight + "px";
    }

    document.addEventListener("DOMContentLoaded", () => {
      const inputField = document.getElementById("maininput");
      const highlight = document.getElementById("highlight");

      // seed textarea with sample content if empty
      if (!inputField.value.trim()) {
        inputField.value = `There are some cases where the the standard grammar\ncheckers don't cut it. That;s where Harper comes in handy.\n\nHarper is an language checker for developers. It can detect improper capitalization and misspellled words, as well as a number of other issues. Like if you break up words you shoul dn't. Harper can be an lifesaver when writing technical documents, emails or other formal forms of communication.\n\nHarper works everywhere, even when you're not online. Since your data never leaves your device, you don't ned too worry aout us selling it or using it to train large language models.\n\nThe best part: Harper can give you feedback instantly. For most documents, Harper can serve up suggestions in under 10 ms, faster that Grammarly.`;
      }

      function debounce(fn, delay) {
        let timer;
        return (...args) => {
          clearTimeout(timer);
          timer = setTimeout(() => fn(...args), delay);
        };
      }

      const debouncedInput = debounce(onInput, 120);

      inputField.addEventListener("input", e => { autoResize(); debouncedInput(e); });

      inputField.addEventListener("scroll", () => {
        highlight.scrollTop = inputField.scrollTop;
        highlight.scrollLeft = inputField.scrollLeft;
      });

      autoResize();
      onInput({ target: inputField });
    });
  </script>
</head>
<body style="margin:0; background:#fafafa; font-family:Inter, sans-serif;">

<div style="display:flex; height:100vh; overflow:hidden;">
  <!-- LEFT SIDE: EDITOR CARD -->
  <div style="flex:2; padding:24px; overflow-y:auto;">
    <div style="background:white; border:1px solid #e5e5e5; border-radius:12px; padding:24px; box-shadow:0 1px 2px rgba(0,0,0,0.04);">
      <div class="editor-wrapper" style="min-height:500px;">
        <div id="highlight" class="highlight-layer"></div>
        <textarea id="maininput" style="width:100%; border:none; outline:none; font-size:16px; line-height:1.6; resize:none;"></textarea>
      </div>
    </div>
  </div>

  <!-- RIGHT SIDE: PROBLEMS PANEL -->
  <div style="flex:1; background:white; border-left:1px solid #e5e5e5; padding:24px; overflow-y:auto; box-shadow:-1px 0 3px rgba(0,0,0,0.04);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <h2 style="margin:0; font-size:20px; font-weight:600;">Problems</h2>
      <div>
        <button style="background:#f3f3f3; border:1px solid #ddd; border-radius:6px; padding:6px 10px; margin-right:6px; cursor:pointer;">Open all</button>
        <button style="background:#f3f3f3; border:1px solid #ddd; border-radius:6px; padding:6px 10px; cursor:pointer;">Ignore all</button>
      </div>
    </div>

    <div id="problemsList" style="display:flex; flex-direction:column; gap:12px;"></div>
  </div>
</div>

<!-- FLOATING TOOLTIP → EXACT HARPER STYLE -->
<div id="lintTooltip" style="position:absolute; display:none; background:white; border:1px solid #e1e1e1; padding:16px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.12); font-size:14px; max-width:260px; z-index:1000;"></div>

</body>
</html>
