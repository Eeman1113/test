<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>harper js</title>

  <style>
    body { font-family: sans-serif; }
    mark.err { background: #ffcccc; border-bottom: 2px solid #c94a4a; padding: 0 2px; color: inherit; display: inline; }
    .editor-wrapper { position: relative; width: 100%; min-height: 200px; margin-bottom: 2rem; }
    .highlight-layer {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      white-space: pre-wrap; pointer-events: none; padding: 8px;
      color: transparent; overflow-wrap: break-word; z-index: 1;
      line-height: 1.5;
      font-family: sans-serif;
      font-size: 16px;
    }
    #maininput {
      position: relative; z-index: 2; background: transparent; color: black;
      width: 100%; min-height: 200px; padding: 8px; resize: none; overflow: hidden;
      line-height: 1.5;
      font-family: sans-serif;
      font-size: 16px;
    }
    .error-text { color: #c94a4a; font-weight: bold; }
    .error-message { color: #555; }
    .error-suggestion { color: #4CAF50; font-style: italic; }
  </style>

  <script type="module">
    import { WorkerLinter } from "https://cdn.jsdelivr.net/npm/harper.js@0.14.0/dist/harper.js";

    const harperConfig = {
      linters: {
        SentenceCapitalization: true,
        Spaces: true,
        SpellCheck: true,
        RepeatedWords: true,
        AnA: true,
        Matcher: true
      }
    };

    let linter = new WorkerLinter(harperConfig);

    function applyHighlights(text, lints) {
      let html = "";
      let lastIndex = 0;

      for (let l of lints) {
        const sp = l.span();
        const start = sp.start;
        const end = sp.end;

        html += escapeHTML(text.slice(lastIndex, start));
        html += `<mark class="err">${escapeHTML(text.slice(start, end))}</mark>`;
        lastIndex = end;
      }

      html += escapeHTML(text.slice(lastIndex));
      return html;
    }

    function escapeHTML(str) {
      return str.replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");
    }

    async function onInput(e) {
      const textToLint = e.target.value.replace(/\u00A0/g, " ");
      let lints = await linter.lint(textToLint);

      document.getElementById("highlight").innerHTML = applyHighlights(textToLint, lints);

      let list = document.getElementById("problemsList");
      list.innerHTML = "";

      for (let lint of lints) {
        const sp = lint.span();
        const bad = textToLint.substring(sp.start, sp.end);

        let li = document.createElement("li");

        let badSpan = document.createElement("span");
        badSpan.className = "error-text";
        badSpan.textContent = `"${bad}"`;
        li.appendChild(badSpan);

        let msgSpan = document.createElement("span");
        msgSpan.className = "error-message";
        msgSpan.textContent = ` — ${lint.message()}`;
        li.appendChild(msgSpan);

        if (lint.suggestion_count() > 0) {
          const suggestions = [...lint.suggestions()]
            .map(s => `‘${s.get_replacement_text()}’`)
            .join(", ");

          let sugSpan = document.createElement("span");
          sugSpan.className = "error-suggestion";
          sugSpan.textContent = ` Suggestion(s): ${suggestions}`;
          li.appendChild(sugSpan);
        }

        
        const card = document.createElement("div");
        card.style.border = "1px solid #ddd";
        card.style.borderRadius = "10px";
        card.style.padding = "12px";
        card.style.background = "#fff";
        card.style.boxShadow = "0 1px 2px rgba(0,0,0,0.05)";
        card.style.display = "flex";
        card.style.flexDirection = "column";
        card.innerHTML = `
          <div style='font-weight:600; margin-bottom:6px;'>${lint.linter_name()}</div>
          <div style='font-size:14px; color:#444;'>${lint.message()}</div>
          <div style='margin-top:8px; font-size:13px; color:#888;'>${escapeHTML(bad)}</div>
        `;
        list.appendChild(card);
      }
    }

    function autoResize() {
      const input = inputField;
      const ghost = highlight;
      input.style.height = "auto";
      input.style.height = input.scrollHeight + "px";
      ghost.style.height = input.scrollHeight + "px";
    }

    document.addEventListener("DOMContentLoaded", () => {
      const inputField = document.getElementById("maininput");
      const highlight = document.getElementById("highlight");

      function debounce(fn, delay) {
        let timer;
        return (...args) => {
          clearTimeout(timer);
          timer = setTimeout(() => fn(...args), delay);
        };
      }

      const debouncedInput = debounce(onInput, 120);

      inputField.addEventListener("input", e => { autoResize(); debouncedInput(e); });

      inputField.addEventListener("scroll", () => {
        highlight.scrollTop = inputField.scrollTop;
        highlight.scrollLeft = inputField.scrollLeft;
      });

      onInput({ target: inputField });
    });
  </script>
</head>
<body style="margin:0; background:#fafafa; font-family:Inter, sans-serif;">

<div style="display:flex; height:100vh; overflow:hidden;">
  <!-- LEFT SIDE: EDITOR CARD -->
  <div style="flex:2; padding:24px; overflow-y:auto;">
    <div style="background:white; border:1px solid #e5e5e5; border-radius:12px; padding:24px; box-shadow:0 1px 2px rgba(0,0,0,0.04);">
      <div class="editor-wrapper" style="min-height:500px;">
        <div id="highlight" class="highlight-layer"></div>
        <textarea id="maininput" style="width:100%; border:none; outline:none; font-size:16px; line-height:1.6; resize:none;"></textarea>
      </div>
    </div>
  </div>

  <!-- RIGHT SIDE: PROBLEMS PANEL -->
  <div style="flex:1; background:white; border-left:1px solid #e5e5e5; padding:24px; overflow-y:auto; box-shadow:-1px 0 3px rgba(0,0,0,0.04);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <h2 style="margin:0; font-size:20px; font-weight:600;">Problems</h2>
      <div>
        <button style="background:#f3f3f3; border:1px solid #ddd; border-radius:6px; padding:6px 10px; margin-right:6px; cursor:pointer;">Open all</button>
        <button style="background:#f3f3f3; border:1px solid #ddd; border-radius:6px; padding:6px 10px; cursor:pointer;">Ignore all</button>
      </div>
    </div>

    <div id="problemsList" style="display:flex; flex-direction:column; gap:12px;"></div>
  </div>
</div>

<!-- FLOATING TOOLTIP → EXACT HARPER STYLE -->
<div id="lintTooltip" style="position:absolute; display:none; background:white; border:1px solid #e1e1e1; padding:16px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.12); font-size:14px; max-width:260px; z-index:1000;"></div>

</body>
</html>
